# Import/Export

The import/export mechanism hinges around 3 key components:

1. An `ImportController` that manages `Import` CRD instances
2. An `ExportController` that manages `Export` CRD instances
3. A REST-based `SubscriptionBoard` service that exposes dynamic routes to PEs

The user scenario below explores, step by step,  the role of these components in
resolving import/export connections.

## User scenario

For this deep dive, we consider the following user scenario:

* User submits `Job A` with a single exported stream, named `streams0`
* User submits `Job B` that imports the named stream `streams0`

### User submits Job A

#### Step 1 : user submits the new Job 
```
$ kubectl apply -f JobA.yaml
```
#### Step 2 : Kubernetes notifies the Job controller

Upon addition of the `Job A` resource, the job controller inspects the AADLs
generated by the pipeline for [imports][01] and [exports][02]. In the case of `Job A`, the
import set is empty. 

Then, the job controller [processes the import and export sets][03]. For each export
the controller calls [`ExportFactory::addExport`][04] to create an `Export` CRD instance.
In the case of `Job A`, a single `Export` instance is created.

#### Step 3 : Kubernetes notifies the Export controller

Upon addition of the new `Export` resource, the [export controller][25] calls
[`ImportExportBroker::add`][05]. For this new `Export`, there is no `Import` to be matched
so nothing is done.

### User submits Job B

#### Step 1 : user submits the new Job 
```
$ kubectl apply -f JobB.yaml
```
#### Step 2 : Kubernetes notifies the Job controller

Upon addition of the `Job B` resource, the job controller inspects the AADLs
generated by the pipeline for [imports][06] and [exports][07]. In the case of `Job B`,
the export set is empty. 

Then, the job controller [processes the import and export sets][08]. For each import
the controller calls [`ImportFactory::addImport`][09] to create an `Import` CRD
instance. In the case of `Job B`, a single `Import` instance is created.

#### Step 3 : Kubernetes notifies the Import controller

Upon addition of the new `Import` resource, the [import controller][26] calls
[`ImportExportBroker::add`][10]. The method will match the new `Import` with all existing
`Export`. In this scenario, the `Export` created by `Job A` is matched.

#### Step 4 : the broker updates the subscription board and notifies the PEs

Since there is a match, the `ImportExportBroker` [updates the subscription
board][23] with the new route information for the importing PE. Then, [it sends a
datagram notification][24] to the target PE.

### In the meantime : PEs poll the subscription board

PEs use a `pull` model to update their dynamic routes. This model is implemented
using a [periodic polling mechanism][20] that fetches routes for a PE every minute.

Route updates only impact PEs with `Import` operators. `Job A` has no `Import` operator,
so its dynamic routes are not updated.

For `Job B`, once the subscription board is updated, the notification sent to
the PE [is received][21]. The content of the subscription board for that PE is
then [fetched][27] and [compared][28] to its local copy.

Finally, the modifications are translated into route [`ADD`][29], [`DEL`][30] and
[`UPDATE`][31] signals to the PE.

## Reference

### Bootstrapping

The bootstrapping section for imports and export is located [in the job controller][11].


#### Import

1. Collect input ports that contain imported streams
2. Create an `Import` CRD for each of the imported stream

#### Export

1. Collect output ports that contain exported streams
2. Create an `Export` CRD for each of the exported stream group

### Custom resource definitions

#### Import

The `Import` CRD contains [the following attributes][12]:

1. Its job ID
2. Its PE ID
3. Its port ID
4. Its port index
5. Its `ImportedStreams` object

#### Export

The `Export` CRD contains [the following attributes][13]:

1. Its PE ID
2. Its port ID
3. Its `ExportedStreams` object

### Matching

Import/Export matching is handled by a synchronized `Broker` [object][14].

When the `Import` controller is notified of the creation of an `Import` CRD instance,
`Export` are [matched through the broker][15]. When the `Export` controller is notified of
the creation of an `Export` CRD instance, `Import` are also [matched through the broker][16].

Matched `Import` and `Export` and exposed to PEs using a [REST service][17]. The
service is updated by the broken each time an `Import` or an `Export` is
matched ([here][18] and [here][19]).

### Route update

PEs use a `pull` model to update their dynamic routes. This model is implemented
using a [periodic polling mechanism][20] that fetches routes for a PE every minute.

In addition to that, PEs are notified of a match using a [datagram notification][21].
This notification is unreliable by design.

### Programming interface

PEs use the REST interface to implement filter and subscription changes from an
operator (eg. [adding properties][22]).

### Reliability

If the instance controller restarts after a failure, the matching is
automatically recomputed using the values from existing `Import` and `Export`
instances.

[01]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/jobs/JobController.java#L444
[02]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/jobs/JobController.java#L443
[03]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/jobs/JobController.java#L457-L458
[04]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/exports/ExportFactory.java#L70
[05]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/instance/utils/ImportExportBroker.java#L277
[06]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/jobs/JobController.java#L444
[07]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/jobs/JobController.java#L443
[08]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/jobs/JobController.java#L457-L458
[09]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/imports/ImportFactory.java#L55
[10]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/instance/utils/ImportExportBroker.java#L262
[11]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/jobs/JobController.java#L457-L458
[12]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/imports/ImportSpec.java#L14-L18
[13]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/exports/ExportSpec.java#L14-L16
[14]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/instance/utils/ImportExportBroker.java#L30
[15]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/imports/ImportController.java#L55
[16]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/exports/ExportController.java#L55
[17]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/instance/rest/services/SubscriptionsService.java#L80
[18]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/instance/utils/ImportExportBroker.java#L268
[19]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/platform/com.ibm.streams.controller/src/com/ibm/streams/controller/instance/utils/ImportExportBroker.java#L293
[20]: https://github.com/IBMStreams/OSStreams/blob/main/src/cpp/K8S/K8SSubscriptionsThread.cpp#L118
[21]: https://github.com/IBMStreams/OSStreams/blob/main/src/cpp/K8S/K8SSubscriptionsThread.cpp#L131
[22]: https://github.com/IBMStreams/OSStreams/blob/main/src/cpp/K8S/K8SPlatform.cpp#L68
[23]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/com.ibm.streams.controller/src/com/ibm/streams/controller/instance/utils/ImportExportBroker.java#L315
[24]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/imports/ImportController.java#L54
[25]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/exports/ExportController.java#L54
[26]: https://github.com/IBMStreams/OSStreams/blob/main/src/java/com.ibm.streams.controller/src/com/ibm/streams/controller/crds/imports/ImportController.java#L55
[27]: https://github.com/IBMStreams/OSStreams/blob/main/src/cpp/src/K8S/K8SSubscriptionsThread.cpp#L156
[28]: https://github.com/IBMStreams/OSStreams/blob/main/src/cpp/src/K8S/K8SSubscriptionsThread.cpp#L178
[29]: https://github.com/IBMStreams/OSStreams/blob/main/src/cpp/src/K8S/K8SSubscriptionsThread.cpp#L287
[30]: https://github.com/IBMStreams/OSStreams/blob/main/src/cpp/src/K8S/K8SSubscriptionsThread.cpp#L297
[31]: https://github.com/IBMStreams/OSStreams/blob/main/src/cpp/src/K8S/K8SSubscriptionsThread.cpp#L307
